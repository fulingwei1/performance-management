# 待修复问题清单（按优先级）

> 基于《系统功能完整性审查报告》生成  
> 更新时间: 2026-02-12

---

## 🔴 P0 - 立即修复（阻塞主流程）

### P0-1: GM路由未注册
- **ID**: 1.1
- **问题**: GM登录后侧栏菜单点击404
- **影响**: GM无法使用系统
- **工作量**: 2小时
- **修复方案**:
  ```typescript
  // app/src/App.tsx
  // 选择方案A: 注册GM路由
  <Route path="/gm">
    <Route path="dashboard" element={<ProtectedRoute><Layout><GMDashboard /></Layout></ProtectedRoute>} />
    <Route path="scoring" element={<ProtectedRoute><Layout><GMScoring /></Layout></ProtectedRoute>} />
    <Route path="analytics" element={<ProtectedRoute><Layout><GMAnalytics /></Layout></ProtectedRoute>} />
  </Route>
  
  // 或方案B: 修改GM登录后重定向
  // backend/src/controllers/auth.controller.ts
  if (role === 'gm') {
    return res.json({ ..., redirect: '/hr/dashboard' });
  }
  
  // 同时移除侧边栏无效菜单
  ```
- **验证**: GM登录后点击所有菜单项

### P0-2: 错误响应字段不统一
- **ID**: 2.1
- **问题**: 后端返回 `message` 或 `error`，前端仅读 `error`
- **影响**: 登录失败等场景用户看不到具体原因
- **工作量**: 半天
- **修复方案**:
  ```typescript
  // 1. 后端统一返回message字段
  // backend/src/controllers/*.ts
  res.status(400).json({ success: false, message: '具体错误原因' });
  
  // 2. 前端统一读取
  // app/src/services/api.ts
  const errorMsg = data.message ?? data.error ?? '请求失败';
  throw new Error(errorMsg);
  ```
- **验证**: 测试登录失败、创建员工失败等场景的错误提示

### P0-3: 必填字段验证缺失
- **ID**: 2.2
- **问题**: 部分API未验证必填字段，依赖前端验证
- **影响**: 后端可能接受无效数据
- **工作量**: 1天
- **修复方案**:
  ```typescript
  // backend/src/controllers/objective.controller.ts
  export const create = [
    body('title').notEmpty().withMessage('目标标题不能为空'),
    body('ownerId').notEmpty().withMessage('负责人不能为空'),
    body('year').isInt().withMessage('年份必须是整数'),
    // ...其他验证规则
    
    asyncHandler(async (req, res) => {
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).json({
          success: false,
          message: errors.array()[0].msg
        });
      }
      // ...
    })
  ];
  ```
- **验证**: Postman测试所有POST/PUT接口，缺少必填字段时应返回400

---

## 🟠 P1 - 高优先级（1-2周内完成）

### P1-1: 绩效申诉流程完全缺失
- **ID**: 1.2
- **问题**: 考核周期有申诉配置，但无申诉功能
- **影响**: 考核流程不完整
- **工作量**: 2天
- **修复方案**:
  1. **创建数据表**:
     ```sql
     CREATE TABLE appeals (
       id TEXT PRIMARY KEY,
       performance_record_id TEXT REFERENCES performance_records(id),
       employee_id TEXT REFERENCES employees(id),
       reason TEXT NOT NULL,
       status TEXT CHECK (status IN ('pending', 'approved', 'rejected')),
       hr_comment TEXT,
       hr_id TEXT REFERENCES employees(id),
       created_at TIMESTAMP DEFAULT NOW(),
       updated_at TIMESTAMP DEFAULT NOW()
     );
     ```
  
  2. **后端API**:
     - `POST /api/appeals` - 提交申诉
     - `GET /api/appeals` - 查询申诉（员工看自己，HR看全部）
     - `PUT /api/appeals/:id/review` - HR处理申诉
  
  3. **前端页面**:
     - `app/src/pages/Employee/PerformanceAppeals.tsx` - 员工申诉页面
     - `app/src/pages/HR/AppealsManagement.tsx` - HR处理页面
  
  4. **集成到侧边栏**:
     - 员工菜单增加"绩效申诉"
     - HR菜单增加"申诉管理"

- **验证**: 员工提交申诉→HR查看并处理→员工看到处理结果

### P1-2: 考核结果发布功能缺失
- **ID**: 1.3
- **问题**: 无法标记周期为"已发布"
- **影响**: 考核流程无正式闭环
- **工作量**: 1天
- **修复方案**:
  1. **修改数据表**:
     ```sql
     ALTER TABLE assessment_cycles
     ADD COLUMN published BOOLEAN DEFAULT FALSE,
     ADD COLUMN published_at TIMESTAMP,
     ADD COLUMN published_by TEXT REFERENCES employees(id);
     ```
  
  2. **后端API**:
     - `POST /api/assessment-cycles/:id/publish` - 发布结果
  
  3. **前端修改**:
     - `pages/HR/AssessmentCycleManagement.tsx` 增加"发布"按钮
     - `pages/Employee/MyScores.tsx` 区分草稿和正式结果
  
- **验证**: HR发布周期→员工看到"已发布"标识

### P1-3: 目标审批流程未完成
- **ID**: 1.4
- **问题**: 后端代码在.bak文件中，未集成
- **影响**: 目标创建后无法审批
- **工作量**: 3天
- **修复方案**:
  1. **恢复后端文件**:
     ```bash
     cd backend/src
     cp models/objectiveAdjustment.model.ts.bak models/objectiveAdjustment.model.ts
     cp controllers/goalApproval.controller.ts.bak controllers/goalApproval.controller.ts
     cp routes/goalApproval.routes.ts.bak routes/goalApproval.routes.ts
     ```
  
  2. **修改objective.model.ts**（见 `目标审批功能开发进度.md`）:
     - 添加 submitForApproval()
     - 添加 approveObjective()
     - 添加 rejectObjective()
     - 添加 getPendingApprovals()
  
  3. **注册路由**:
     ```typescript
     // backend/src/index.ts
     import goalApprovalRoutes from './routes/goalApproval.routes';
     app.use('/api/goal-approval', goalApprovalRoutes);
     ```
  
  4. **创建前端页面**:
     - `app/src/pages/Manager/GoalApproval.tsx` - 审批列表和详情
  
  5. **集成到员工页面**:
     - `pages/Employee/MyGoalPlanning.tsx` 增加"提交审批"按钮
  
- **验证**: 员工提交→经理审批/拒绝/调整→员工看到结果

### P1-4: 自动提交与提醒功能未实现
- **ID**: 1.5
- **问题**: 周期配置中有提醒和自动提交，但未实现
- **影响**: 配置项无效，可能错过截止日
- **工作量**: 2天
- **修复方案**:
  1. **安装依赖**:
     ```bash
     cd backend && npm install node-cron
     ```
  
  2. **创建定时任务**:
     ```typescript
     // backend/src/jobs/assessmentReminder.ts
     import cron from 'node-cron';
     
     // 每天早上9点检查
     cron.schedule('0 9 * * *', async () => {
       // 1. 查询即将到期的周期（距截止日≤提醒天数）
       // 2. 查询未提交的员工
       // 3. 创建站内提醒记录
       // 4. 可选: 发送邮件/企业微信
     });
     
     // 每天晚上12点检查自动提交
     cron.schedule('0 0 * * *', async () => {
       // 1. 查询已过期的周期（且开启自动提交）
       // 2. 查询未提交的员工
       // 3. 自动创建空白总结或标记
     });
     ```
  
  3. **创建站内消息表**:
     ```sql
     CREATE TABLE notifications (
       id TEXT PRIMARY KEY,
       user_id TEXT REFERENCES employees(id),
       type TEXT, -- 'reminder', 'approval', 'system'
       title TEXT,
       content TEXT,
       read BOOLEAN DEFAULT FALSE,
       created_at TIMESTAMP DEFAULT NOW()
     );
     ```
  
  4. **前端显示**:
     - 顶部导航栏增加消息图标（显示未读数）
     - 创建 `pages/Notifications.tsx` 消息中心
  
- **验证**: 
  - 设置测试周期截止日为明天
  - 等待定时任务触发（或手动调用）
  - 检查站内消息是否生成

### P1-5: 同事互评提交是假实现
- **ID**: 1.7
- **问题**: 前端提交互评仅用setTimeout模拟
- **影响**: 互评数据未保存
- **工作量**: 1小时
- **修复方案**:
  ```typescript
  // app/src/stores/performanceStore.ts
  submitPeerReview: async (data) => {
    set({ loading: true, error: null });
    try {
      // 改为调用真实API（后端已存在）
      const response = await fetch(`${API_BASE_URL}/api/peer-reviews/submit`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      if (result.success) {
        set({ loading: false });
        return true;
      } else {
        set({ error: result.message || '提交失败', loading: false });
        return false;
      }
    } catch (error) {
      set({ error: '网络错误', loading: false });
      return false;
    }
  }
  ```
- **验证**: 提交互评后检查数据库是否有记录

### P1-6: 拆分超大组件文件
- **ID**: 3.1
- **问题**: 多个文件超过500行，难以维护
- **影响**: 可读性差，协作困难
- **工作量**: 2天
- **修复方案**（以HR Dashboard为例）:
  ```
  原文件: pages/HR/Dashboard.tsx (1076行)
  
  拆分后:
  pages/HR/Dashboard/
    ├── index.tsx (主文件，100行)
    ├── StatCards.tsx (统计卡片，150行)
    ├── DeptPerformanceTable.tsx (部门表格，200行)
    ├── EmployeeDetailDrawer.tsx (员工详情，200行)
    ├── FilterPanel.tsx (筛选面板，150行)
    └── DeleteRecordsDialog.tsx (删除对话框，150行)
  ```
  
  同样处理:
  - `pages/Manager/Scoring.tsx` (887行)
  - `pages/HR/EmployeeManagement.tsx` (814行)
  - `pages/HR/HRDataImportCenter.tsx` (776行)
  - `stores/hrStore.ts` (651行)
  
- **验证**: 功能无变化，代码更清晰

---

## 🟡 P2 - 中优先级（1个月内完成）

### P2-1: 待办与提醒模块
- **ID**: 2.3
- **工作量**: 2天
- **修复方案**: 各角色Dashboard顶部增加待办卡片

### P2-2: 历史数据与趋势分析
- **ID**: 2.4
- **工作量**: 3天
- **修复方案**: 增加趋势图和历史筛选

### P2-3: 批量操作支持
- **ID**: 2.5
- **工作量**: 2天
- **修复方案**: 列表增加多选和批量操作

### P2-4: AI功能补全
- **ID**: 2.6
- **工作量**: 1天
- **修复方案**: 为剩余文本框增加AI按钮

### P2-5: 消除any类型
- **ID**: 4.1
- **工作量**: 1周
- **修复方案**: 从数据库层开始定义准确类型

### P2-6: 替换console.log为结构化日志
- **ID**: 4.3
- **工作量**: 2天
- **修复方案**: 引入pino，替换80处console.log

### P2-7: 替换MySQL错误码为PostgreSQL
- **ID**: 4.2
- **工作量**: 半天
- **修复方案**: errorHandler.ts中替换错误码

### P2-8: 完善Loading和空状态
- **ID**: 3.2
- **工作量**: 3天
- **修复方案**: 增加Skeleton和Empty组件

### P2-9: 补充测试覆盖
- **ID**: 4.7
- **工作量**: 1周
- **修复方案**: 修复失败测试，增加前端测试

---

## 🟢 P3 - 低优先级（持续优化）

### P3-1: 进度仪表板
- **ID**: 1.6
- **工作量**: 3天

### P3-2: 进度记录关联查询优化
- **ID**: 2.7
- **工作量**: 半天

### P3-3: Token过期续期机制
- **ID**: 2.8
- **工作量**: 1天

### P3-4: 移动端适配
- **ID**: 2.9
- **工作量**: 1周

### P3-5: 表单验证提示优化
- **ID**: 3.3
- **工作量**: 2天

### P3-6: 操作确认对话框
- **ID**: 3.4
- **工作量**: 1天

### P3-7: Toast消息优化
- **ID**: 3.5
- **工作量**: 1天

### P3-8: 导出功能增强
- **ID**: 3.6
- **工作量**: 2天

### P3-9: 搜索与筛选优化
- **ID**: 3.7
- **工作量**: 2天

### P3-10: SQL兼容层重构
- **ID**: 4.4
- **工作量**: 3天

### P3-11: 数据库索引补充
- **ID**: 4.5
- **工作量**: 1天

### P3-12: 前端路由结构重构
- **ID**: 4.6
- **工作量**: 2天

### P3-13: 环境变量启动验证
- **ID**: 4.8
- **工作量**: 半天

### P3-14: 清理构建产物
- **ID**: 4.9
- **工作量**: 半小时

---

## 📋 快速修复检查清单

### 今天可以完成（≤4小时）
- [ ] P0-1: GM路由注册 (2h)
- [ ] P0-2: 错误响应统一 (4h)
- [ ] P1-5: 互评提交修复 (1h)
- [ ] P2-7: MySQL错误码替换 (0.5h)
- [ ] P3-14: 清理构建产物 (0.5h)

### 本周可以完成（≤2天）
- [ ] P0-3: 必填字段验证 (1d)
- [ ] P1-2: 结果发布功能 (1d)
- [ ] P1-4: 定时任务框架 (2d)
- [ ] P1-6: 拆分大文件 (2d)

### 本月可以完成（≤1周）
- [ ] P1-1: 申诉流程 (2d)
- [ ] P1-3: 目标审批 (3d)
- [ ] P2-5: 消除any类型 (1w)
- [ ] P2-9: 补充测试 (1w)

---

## 🎯 建议工作顺序

### Week 1: 核心流程修复
```
Day 1: P0-1 (GM路由) + P0-2 (错误统一) + P1-5 (互评)
Day 2-3: P0-3 (字段验证)
Day 4-5: P1-2 (结果发布) + P2-7 (错误码)
```

### Week 2: 重要功能补全
```
Day 1-2: P1-1 (申诉流程)
Day 3-5: P1-3 (目标审批)
```

### Week 3-4: 代码质量提升
```
Week 3: P1-4 (定时任务) + P1-6 (拆分文件) + P2-6 (日志)
Week 4: P2-5 (类型安全) + P2-9 (测试)
```

### Month 2+: 体验优化
```
P2-1~P2-4 (待办/趋势/批量/AI)
P3-1~P3-14 (其他优化项)
```

---

## 📞 需要外部支持的项目

1. **Kimi API Key** (P1-4 需要)
   - AI功能已实现，需配置API密钥

2. **邮件/企业微信集成** (P1-4 可选)
   - 定时提醒可先做站内消息
   - 后续集成外部推送

3. **数据库性能调优** (P3-11)
   - 生产环境数据量增长后需DBA支持

---

**使用说明**:
- 每完成一项，在清单中标记 `[x]`
- 发现新问题时，评估优先级后添加到对应区域
- 每周Review进度，调整优先级

**最后更新**: 2026-02-12 16:46 GMT+8
