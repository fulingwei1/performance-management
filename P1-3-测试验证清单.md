# P1-3 目标审批流程 - 测试验证清单

## 完成状态

### ✅ 后端开发
- [x] 恢复 objectiveAdjustment.model.ts
- [x] 恢复 goalApproval.controller.ts  
- [x] 恢复 goalApproval.routes.ts
- [x] objective.model.ts 添加审批方法
- [x] 注册 goal-approval 路由
- [x] 数据库迁移文件创建并执行
- [x] 后端服务正常运行

### ✅ 前端开发
- [x] 创建经理审批页面 (Manager/GoalApproval.tsx)
- [x] 修改员工目标页面 (Employee/MyGoalPlanning.tsx)
- [x] 更新 Sidebar 菜单
- [x] 注册前端路由
- [x] 前端编译无错误

---

## 🧪 浏览器测试步骤

### 1. 员工提交目标审批

**登录信息**：
- 用户：普通员工账号
- URL: http://localhost:5173/employee/my-objectives

**测试步骤**：
1. 登录员工账号
2. 进入"我的目标规划"页面
3. 创建/编辑个人目标
4. 确保目标权重总和 = 100%
5. 点击"提交给经理审批"按钮
6. 验证状态变为"待审批"（黄色Badge）
7. 验证编辑功能被禁用
8. 验证弹出成功提示

**预期结果**：
- ✅ 目标状态显示"待审批"
- ✅ 目标不可编辑
- ✅ 显示黄色Alert："您的年度目标已提交，等待经理审批"

---

### 2. 经理审批目标

**登录信息**：
- 用户：经理账号（员工的直属经理）
- URL: http://localhost:5173/manager/goal-approval

**测试步骤（批准）**：
1. 登录经理账号
2. 点击侧边栏"目标审批"菜单
3. 验证可以看到待审批目标列表
4. 点击某个目标的"批准"按钮
5. 在对话框中填写备注（可选）
6. 点击"确认批准"
7. 验证目标从列表中消失
8. 验证弹出成功提示

**测试步骤（拒绝）**：
1. 点击另一个目标的"拒绝"按钮
2. 在对话框中填写拒绝原因（必填）
3. 点击"确认拒绝"
4. 验证目标从列表中消失
5. 验证弹出成功提示

**预期结果**：
- ✅ 待审批目标列表正确显示
- ✅ 显示员工姓名、部门、目标信息
- ✅ 批准/拒绝操作成功
- ✅ 拒绝时必须填写原因

---

### 3. 员工查看审批结果

**测试步骤（批准）**：
1. 切换回员工账号
2. 刷新"我的目标规划"页面
3. 验证批准的目标状态为"已批准"（绿色Badge）
4. 验证显示绿色Alert："您的年度目标已获批准！"
5. 验证目标仍不可编辑

**测试步骤（拒绝）**：
1. 验证被拒绝的目标状态为"已拒绝"（红色Badge）
2. 验证显示红色Alert，包含拒绝原因
3. 验证目标变为可编辑
4. 修改目标
5. 点击"重新提交审批"
6. 验证状态重新变为"待审批"

**预期结果**：
- ✅ 已批准：绿色状态，不可编辑
- ✅ 已拒绝：红色状态，显示拒绝原因，可编辑
- ✅ 可重新提交审批

---

## 🔧 API测试（可选）

### 1. 获取待审批目标
```bash
GET /api/goal-approval/pending
Headers: Authorization: Bearer <manager_token>
```

### 2. 批准目标
```bash
POST /api/goal-approval/approve
Headers: Authorization: Bearer <manager_token>
Body: {
  "objectiveId": "obj-xxx",
  "comment": "目标设定合理"
}
```

### 3. 拒绝目标
```bash
POST /api/goal-approval/reject
Headers: Authorization: Bearer <manager_token>
Body: {
  "objectiveId": "obj-xxx",
  "comment": "目标权重分配不合理，请重新调整"
}
```

---

## ⚠️ 已知问题

1. **测试数据问题**：
   - 部分员工账号缺少 email 字段
   - 需要确保测试员工有 manager_id（直属经理）
   
2. **权限验证**：
   - 只有直属经理可以审批下属目标
   - 非直属经理会收到403错误

---

## 📝 测试建议

1. 准备2-3组测试账号（员工+对应经理）
2. 先用浏览器测试完整流程
3. 重点验证状态流转和权限控制
4. 测试异常场景（非直属经理审批、重复提交等）

---

## 🎯 验收标准

- [ ] 员工可以提交目标到审批流程
- [ ] 经理可以看到待审批目标列表
- [ ] 经理可以批准/拒绝目标
- [ ] 员工可以看到审批结果和拒绝原因
- [ ] Sidebar菜单正常显示
- [ ] 所有状态流转正确（draft → pending_approval → approved/rejected → draft）
- [ ] 权限控制正确（只能审批直属下属）
- [ ] 数据正确保存到数据库

---

**下一步**：运行浏览器测试，验证完整流程 🚀
