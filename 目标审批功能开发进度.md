# ç›®æ ‡å®¡æ‰¹åŠŸèƒ½å¼€å‘è¿›åº¦

## ğŸ“Š åŠŸèƒ½æ¦‚è¿°

å®ç°å®Œæ•´çš„ç›®æ ‡å®¡æ‰¹æµç¨‹ï¼š
1. **å‘˜å·¥æäº¤ç›®æ ‡** â†’ 2. **ç»ç†å®¡æ‰¹/è°ƒæ•´** â†’ 3. **è¿›åº¦ä»ªè¡¨ç›˜**

## âœ… å·²å®Œæˆ

### 1. æ•°æ®åº“å±‚
- âœ… `supabase/migrations/20260212_goal_approval.sql`
  - æ‰©å±• objectives è¡¨çš„ status æšä¸¾ï¼ˆæ·»åŠ  pending_approval, approved, rejectedï¼‰
  - æ·»åŠ å®¡æ‰¹å­—æ®µï¼šsubmitted_at, reviewed_at, reviewed_by, review_comment, adjustment_reason
  - åˆ›å»º objective_adjustments è¡¨ï¼ˆç›®æ ‡è°ƒæ•´å†å²ï¼‰
  - æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

### 2. ç±»å‹å®šä¹‰
- âœ… `backend/src/types/index.ts`
  - æ›´æ–° Objective æ¥å£ï¼Œæ·»åŠ å®¡æ‰¹ç›¸å…³å­—æ®µ
  - æ–°å¢ ObjectiveAdjustment æ¥å£

### 3. æ¨¡å‹å±‚
- âœ… `backend/src/models/objectiveAdjustment.model.ts`ï¼ˆæ–°å»ºï¼‰
  - `createAdjustment()` - è®°å½•è°ƒæ•´å†å²
  - `getAdjustmentsByObjective()` - è·å–ç›®æ ‡çš„è°ƒæ•´å†å²
  - `getAdjustmentsByManager()` - è·å–ç»ç†çš„è°ƒæ•´è®°å½•
  - âœ… æ”¯æŒå†…å­˜æ•°æ®åº“

- â³ `backend/src/models/objective.model.ts`ï¼ˆå¾…ä¿®æ”¹ï¼‰
  - éœ€è¦æ·»åŠ çš„æ–¹æ³•ï¼š
    - `submitForApproval()` - æäº¤å®¡æ‰¹
    - `approveObjective()` - æ‰¹å‡†ç›®æ ‡
    - `rejectObjective()` - æ‹’ç»ç›®æ ‡
    - `getPendingApprovals()` - è·å–å¾…å®¡æ‰¹åˆ—è¡¨
  - éœ€è¦ä¿®æ”¹ `format()` æ–¹æ³•ï¼Œæ·»åŠ æ–°å­—æ®µæ˜ å°„

###4. æ§åˆ¶å™¨å±‚
- âœ… `backend/src/controllers/goalApproval.controller.ts`ï¼ˆæ–°å»ºï¼‰
  - `getPendingApprovals()` - è·å–å¾…å®¡æ‰¹ç›®æ ‡åˆ—è¡¨
  - `approveObjective()` - æ‰¹å‡†ç›®æ ‡
  - `rejectObjective()` - æ‹’ç»ç›®æ ‡
  - `adjustObjective()` - è°ƒæ•´ç›®æ ‡
  - âœ… æƒé™æ§åˆ¶ï¼ˆåªæœ‰ç»ç†å¯ä»¥å®¡æ‰¹ï¼‰
  - âœ… ä¸‹å±å…³ç³»æ£€æŸ¥

### 5. è·¯ç”±å±‚
- âœ… `backend/src/routes/goalApproval.routes.ts`ï¼ˆæ–°å»ºï¼‰
  - `GET /api/goal-approval/pending` - å¾…å®¡æ‰¹åˆ—è¡¨
  - `POST /api/goal-approval/approve` - æ‰¹å‡†
  - `POST /api/goal-approval/reject` - æ‹’ç»
  - `POST /api/goal-approval/adjust` - è°ƒæ•´
- âœ… å·²åœ¨ `backend/src/index.ts` ä¸­æ³¨å†Œè·¯ç”±

### 6. AI ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½
- âœ… `supabase/migrations/20260212_ai_usage_logs.sql`
- âœ… `backend/src/models/aiUsageLog.model.ts`
- âœ… ä¿®æ”¹äº† AI æ§åˆ¶å™¨ï¼Œè‡ªåŠ¨è®°å½•æ¯æ¬¡è°ƒç”¨
- âœ… æ–°å¢ API æ¥å£ï¼š
  - `GET /api/ai/my-usage` - ä¸ªäººç»Ÿè®¡
  - `GET /api/ai/all-usage` - æ‰€æœ‰äººç»Ÿè®¡ï¼ˆç®¡ç†å‘˜ï¼‰

## â³ è¿›è¡Œä¸­

### objective.model.ts ä¿®æ”¹
éœ€è¦æ‰‹åŠ¨æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼ˆå› ä¸ºè‡ªåŠ¨åŒ–è¿½åŠ å¤±è´¥ï¼‰ï¼š

```typescript
// åœ¨ ObjectiveModel ç±»å†…éƒ¨æ·»åŠ ï¼š

/**
 * æäº¤ç›®æ ‡å®¡æ‰¹
 */
static async submitForApproval(objectiveId: string): Promise<Objective | null> {
  if (USE_MEMORY_DB) {
    const obj = memoryStore.objectives.get(objectiveId);
    if (!obj) return null;
    
    obj.status = 'pending_approval' as any;
    obj.submittedAt = new Date() as any;
    obj.updatedAt = new Date() as any;
    
    return obj;
  }

  const result = await pool!.query(
    `UPDATE objectives 
     SET status = 'pending_approval', submitted_at = CURRENT_TIMESTAMP, updated_at = CURRENT_TIMESTAMP
     WHERE id = $1 
     RETURNING *`,
    [objectiveId]
  );

  return result.rows.length > 0 ? this.format(result.rows[0]) : null;
}

/**
 * æ‰¹å‡†ç›®æ ‡
 */
static async approveObjective(
  objectiveId: string,
  reviewerId: number,
  comment?: string
): Promise<Objective | null> {
  if (USE_MEMORY_DB) {
    const obj = memoryStore.objectives.get(objectiveId);
    if (!obj) return null;
    
    obj.status = 'approved' as any;
    obj.reviewedAt = new Date() as any;
    obj.reviewedBy = reviewerId as any;
    obj.reviewComment = comment as any;
    obj.updatedAt = new Date() as any;
    
    return obj;
  }

  const result = await pool!.query(
    `UPDATE objectives 
     SET status = 'approved', 
         reviewed_at = CURRENT_TIMESTAMP, 
         reviewed_by = $2,
         review_comment = $3,
         updated_at = CURRENT_TIMESTAMP
     WHERE id = $1 
     RETURNING *`,
    [objectiveId, reviewerId, comment]
  );

  return result.rows.length > 0 ? this.format(result.rows[0]) : null;
}

/**
 * æ‹’ç»ç›®æ ‡
 */
static async rejectObjective(
  objectiveId: string,
  reviewerId: number,
  comment: string
): Promise<Objective | null> {
  if (USE_MEMORY_DB) {
    const obj = memoryStore.objectives.get(objectiveId);
    if (!obj) return null;
    
    obj.status = 'rejected' as any;
    obj.reviewedAt = new Date() as any;
    obj.reviewedBy = reviewerId as any;
    obj.reviewComment = comment as any;
    obj.updatedAt = new Date() as any;
    
    return obj;
  }

  const result = await pool!.query(
    `UPDATE objectives 
     SET status = 'rejected', 
           reviewed_at = CURRENT_TIMESTAMP, 
           reviewed_by = $2,
           review_comment = $3,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = $1 
       RETURNING *`,
    [objectiveId, reviewerId, comment]
  );

  return result.rows.length > 0 ? this.format(result.rows[0]) : null;
}

/**
 * è·å–å¾…å®¡æ‰¹çš„ç›®æ ‡åˆ—è¡¨ï¼ˆç»ç†æŸ¥çœ‹ä¸‹å±æäº¤çš„ç›®æ ‡ï¼‰
 */
static async getPendingApprovals(managerId: number): Promise<Objective[]> {
  if (USE_MEMORY_DB) {
    const allObjs = Array.from(memoryStore.objectives.values());
    
    // è·å–è¯¥ç»ç†çš„ä¸‹å±IDåˆ—è¡¨
    const subordinates = Array.from(memoryStore.employees.values())
      .filter(emp => emp.managerId === managerId.toString())
      .map(emp => emp.id);

    return allObjs.filter(obj => 
      obj.level === 'individual' &&
      obj.status === 'pending_approval' &&
      obj.ownerId && subordinates.includes(obj.ownerId.toString())
    );
  }

  const result = await pool!.query(
    `SELECT o.* 
     FROM objectives o
     JOIN users u ON o.owner_id = u.id
     WHERE o.level = 'individual'
       AND o.status = 'pending_approval'
       AND u.manager_id = $1
     ORDER BY o.submitted_at DESC`,
    [managerId]
  );

  return result.rows.map(row => this.format(row));
}
```

åŒæ—¶éœ€è¦ä¿®æ”¹ `format()` æ–¹æ³•ï¼Œåœ¨è¿”å›å¯¹è±¡ä¸­æ·»åŠ ï¼š
```typescript
submittedAt: row.submitted_at,
reviewedAt: row.reviewed_at,
reviewedBy: row.reviewed_by,
reviewComment: row.review_comment,
adjustmentReason: row.adjustment_reason,
```

## âŒ å¾…å¼€å‘

### 1. å‰ç«¯ - ç»ç†å®¡æ‰¹é¡µé¢
- [ ] `/manager/goal-approval` - ç»ç†å®¡æ‰¹é¡µé¢
  - å¾…å®¡æ‰¹ç›®æ ‡åˆ—è¡¨
  - æŸ¥çœ‹å‘˜å·¥æäº¤çš„ç›®æ ‡è¯¦æƒ…
  - æ‰¹å‡†/æ‹’ç»æ“ä½œ
  - ç›®æ ‡è°ƒæ•´åŠŸèƒ½

### 2. å‰ç«¯ - è¿›åº¦ä»ªè¡¨ç›˜
- [ ] `/manager/goal-dashboard` - ç›®æ ‡è¿›åº¦ä»ªè¡¨ç›˜
  - å›¢é˜Ÿç›®æ ‡å®Œæˆæƒ…å†µå¯è§†åŒ–
  - ä¸ªäººç›®æ ‡è¿›åº¦è¿½è¸ª
  - é£é™©é¢„è­¦ï¼ˆè¿›åº¦è½åçš„ç›®æ ‡ï¼‰
  - ç»Ÿè®¡å›¾è¡¨ï¼ˆecharts / rechartsï¼‰

### 3. å‰ç«¯ - å‘˜å·¥ç›®æ ‡æäº¤
- [ ] ä¿®æ”¹ `/employee/goal-planning` é¡µé¢
  - æ·»åŠ "æäº¤å®¡æ‰¹"æŒ‰é’®
  - è°ƒç”¨ `ObjectiveModel.submitForApproval()`
  - æäº¤åçŠ¶æ€å˜ä¸º pending_approvalï¼Œé”å®šç¼–è¾‘

### 4. é€šçŸ¥åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- [ ] å‘˜å·¥æäº¤åé€šçŸ¥ç»ç†
- [ ] ç»ç†å®¡æ‰¹åé€šçŸ¥å‘˜å·¥

## ğŸ”Œ API æ¥å£æ–‡æ¡£

### 1. è·å–å¾…å®¡æ‰¹ç›®æ ‡åˆ—è¡¨
```http
GET /api/goal-approval/pending
Authorization: Bearer <manager_token>
```

**å“åº”**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "title": "2026å¹´Q1é”€å”®ç›®æ ‡",
      "ownerId": 123,
      "ownerName": "å¼ ä¸‰",
      "ownerDepartment": "é”€å”®éƒ¨",
      "status": "pending_approval",
      "submittedAt": "2026-02-12T08:00:00Z",
      "targetValue": "100ä¸‡",
      "quarterlyTargets": {...},
      "weight": 40
    }
  ]
}
```

### 2. æ‰¹å‡†ç›®æ ‡
```http
POST /api/goal-approval/approve
Content-Type: application/json
Authorization: Bearer <manager_token>

{
  "objectiveId": 1,
  "comment": "ç›®æ ‡åˆç†ï¼Œæ‰¹å‡†é€šè¿‡"
}
```

### 3. æ‹’ç»ç›®æ ‡
```http
POST /api/goal-approval/reject
Content-Type: application/json
Authorization: Bearer <manager_token>

{
  "objectiveId": 1,
  "comment": "ç›®æ ‡è¿‡é«˜ï¼Œè¯·é‡æ–°è§„åˆ’"
}
```

### 4. è°ƒæ•´ç›®æ ‡
```http
POST /api/goal-approval/adjust
Content-Type: application/json
Authorization: Bearer <manager_token>

{
  "objectiveId": 1,
  "adjustments": [
    {
      "type": "target_value",
      "oldValue": "100ä¸‡",
      "newValue": "80ä¸‡"
    },
    {
      "type": "weight",
      "oldValue": 40,
      "newValue": 35
    }
  ],
  "reason": "æ ¹æ®å¸‚åœºæƒ…å†µè°ƒæ•´ç›®æ ‡å€¼"
}
```

## ğŸ“Š å·¥ä½œæµç¨‹

1. **å‘˜å·¥è§„åˆ’ç›®æ ‡** `/employee/goal-planning`
   - æŸ¥çœ‹æˆ˜ç•¥ç›®æ ‡
   - æ‹†è§£ä¸ªäººç›®æ ‡ï¼ˆå¹´åº¦ â†’ å­£åº¦ â†’ æœˆåº¦ï¼‰
   - è®¾ç½®æƒé‡
   - ä¿å­˜è‰ç¨¿

2. **å‘˜å·¥æäº¤å®¡æ‰¹**
   - ç‚¹å‡»"æäº¤å®¡æ‰¹"æŒ‰é’®
   - çŠ¶æ€å˜ä¸º `pending_approval`
   - é€šçŸ¥ç»ç†ï¼ˆå¯é€‰ï¼‰

3. **ç»ç†å®¡æ‰¹** `/manager/goal-approval`
   - æŸ¥çœ‹å¾…å®¡æ‰¹ç›®æ ‡åˆ—è¡¨
   - æŸ¥çœ‹ç›®æ ‡è¯¦æƒ…
   - é€‰æ‹©æ“ä½œï¼š
     - **æ‰¹å‡†** â†’ çŠ¶æ€å˜ä¸º `approved`
     - **æ‹’ç»** â†’ çŠ¶æ€å˜ä¸º `rejected`ï¼Œå¡«å†™åŸå› 
     - **è°ƒæ•´** â†’ ä¿®æ”¹ç›®æ ‡å€¼/æƒé‡ï¼Œè®°å½•è°ƒæ•´å†å²

4. **å‘˜å·¥ç¡®è®¤**
   - å¦‚æœè¢«æ‹’ç»ï¼šä¿®æ”¹åé‡æ–°æäº¤
   - å¦‚æœè¢«æ‰¹å‡†ï¼šç¡®è®¤ç›®æ ‡
   - å¦‚æœè¢«è°ƒæ•´ï¼šæŸ¥çœ‹è°ƒæ•´è¯´æ˜ï¼Œç¡®è®¤æˆ–æå‡ºå¼‚è®®

5. **è¿›åº¦è¿½è¸ª** `/manager/goal-dashboard`
   - å®æ—¶æŸ¥çœ‹å›¢é˜Ÿç›®æ ‡è¿›åº¦
   - è¯†åˆ«é£é™©ï¼ˆè¿›åº¦è½åï¼‰
   - æ•°æ®å¯è§†åŒ–

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… æ‰‹åŠ¨ä¿®æ”¹ `objective.model.ts`ï¼Œæ·»åŠ å®¡æ‰¹æ–¹æ³•
2. âœ… æµ‹è¯•åç«¯ç¼–è¯‘
3. âœ… åˆ›å»ºå‰ç«¯å®¡æ‰¹é¡µé¢
4. âœ… åˆ›å»ºè¿›åº¦ä»ªè¡¨ç›˜
5. âœ… é›†æˆæµ‹è¯•
6. âœ… æäº¤åˆ° GitHub

---

**å½“å‰çŠ¶æ€**: åç«¯ 80% å®Œæˆï¼ˆå·® objective.model.ts ä¿®æ”¹ï¼‰ï¼Œå‰ç«¯ 0%
**é¢„è®¡æ—¶é—´**: 2-3 å°æ—¶ï¼ˆåç«¯ä¿®æ”¹ + å‰ç«¯å¼€å‘ + æµ‹è¯•ï¼‰
