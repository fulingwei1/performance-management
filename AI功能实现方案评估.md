# 绩效管理系统 - AI 功能实现方案评估

## 需求总结
1. 员工写自评时 AI 辅助生成总结/计划
2. 经理写评价时 AI 辅助生成评语/安排/推荐关键词
3. AI 需要自动抓取系统数据（目标、绩效、历史）
4. 每个输入框都有 AI 按钮

---

## 方案对比

### 方案A：前端直连 AI API（不推荐）
```
前端 → Kimi/OpenAI API → 返回建议
```

**优点：**
- 实现简单，前端直接调用
- 响应快

**缺点：**
❌ API Key 暴露在前端（极度不安全）
❌ 无法抓取后端数据（需要多次调用）
❌ 成本无法控制（用户可以无限调用）
❌ 无法缓存/复用结果

**结论：不可行**

---

### 方案B：后端代理 AI API（推荐⭐⭐⭐）
```
前端 → 后端API → 抓取数据 → AI模型 → 返回建议
```

**优点：**
✅ API Key 安全（存在后端环境变量）
✅ 可以抓取完整数据（目标、绩效、历史）
✅ 可以做权限控制（每人每月限制调用次数）
✅ 可以缓存结果（相同员工/月份直接返回）
✅ 可以记录日志（谁用了AI，生成了什么）

**缺点：**
- 需要开发后端API
- 需要配置AI服务

**技术实现：**
```typescript
// 后端新增API
POST /api/ai/suggest-self-summary
  → 抓取员工目标、上月评价
  → 调用Kimi API生成建议
  → 返回3个版本供选择

POST /api/ai/suggest-manager-comment
  → 抓取员工数据、绩效、团队对比
  → 调用AI生成评价+关键词
  → 返回建议
```

**估算成本（Kimi API）：**
- 每次生成约 2000 tokens
- 173员工 × 12月 = 2076次/年
- 成本：约 ¥200-300/年（非常便宜）

---

### 方案C：本地 OpenClaw 代理（备选⭐⭐）
```
前端 → 后端 → OpenClaw Agent → Claude模型 → 返回建议
```

**优点：**
✅ 不需要额外AI服务
✅ 利用现有OpenClaw部署
✅ 零额外成本

**缺点：**
⚠️ 需要OpenClaw一直在线
⚠️ 响应可能较慢（需要轮询）
⚠️ 依赖你的OpenClaw配置

**适用场景：**
- Kimi API故障时的备用
- 开发测试阶段

---

### 方案D：混合方案（最佳⭐⭐⭐⭐⭐）
```
前端 → 后端
  ├─→ 优先：Kimi API（快速、便宜）
  └─→ 备用：OpenClaw Agent（免费、稳定）
```

**优点：**
✅ 高可用性（主备切换）
✅ 成本可控
✅ 用户体验好

**实现逻辑：**
```javascript
async function generateAISuggestion(data) {
  try {
    // 主方案：Kimi API
    return await kimiAPI.generate(data);
  } catch (error) {
    console.error('Kimi API failed, fallback to OpenClaw');
    // 备用：OpenClaw
    return await openclawAPI.generate(data);
  }
}
```

---

## 数据抓取设计

### 员工自评 - AI需要的数据
```json
{
  "employee": {
    "name": "张三",
    "level": "中级工程师",
    "department": "研发部"
  },
  "currentGoals": [
    { "name": "完成X项目", "target": "100%", "actual": "95%" }
  ],
  "lastMonthComment": "工作认真，主动性强...",
  "projects": ["项目A", "项目B"]
}
```

### 经理评分 - AI需要的数据
```json
{
  "employee": { ... },
  "selfSummary": "本月完成...",
  "scores": {
    "taskCompletion": 1.2,
    "initiative": 1.1,
    ...
  },
  "goalProgress": [ ... ],
  "historyScores": [
    { "month": "2025-12", "score": 1.15 },
    { "month": "2026-01", "score": 1.08 }
  ],
  "teamAverage": 1.05,
  "rank": "部门第3/15"
}
```

---

## UI/UX 设计

### 方案1：侧边栏 AI 助手（推荐⭐⭐⭐⭐）
```
┌─────────────────┬───────────────┐
│  工作总结       │  🤖 AI 助手   │
│  [文本框]       │  ────────────  │
│                 │  💡 建议1:     │
│                 │  本月完成...   │
│                 │  [采用]        │
│                 │  ────────────  │
│                 │  💡 建议2:     │
│                 │  重点推进...   │
│                 │  [采用]        │
└─────────────────┴───────────────┘
```

**优点：**
- 同时看到输入框和建议
- 可以对比多个版本
- 不影响原有布局

---

### 方案2：浮层弹窗（次选⭐⭐⭐）
```
[工作总结] 🤖 AI生成

点击后弹窗：
┌────────────────────────┐
│  🤖 AI 生成建议         │
│  ──────────────────── │
│  根据您的目标完成情况... │
│  [插入到输入框]         │
│  [重新生成]             │
└────────────────────────┘
```

**优点：**
- 不占用屏幕空间
- 实现简单

**缺点：**
- 需要关闭弹窗才能编辑
- 无法对比多个版本

---

### 方案3：内联按钮（最简单⭐⭐）
```
工作总结：
┌─────────────────────────────┐
│                             │
│  [AI 帮我写] [清空]          │
└─────────────────────────────┘
```

点击后直接替换内容

**优点：**
- 实现最简单
- 节省空间

**缺点：**
- 无法预览
- 无法对比
- 可能覆盖用户已写内容

---

## 提示词设计示例

### 员工自评提示词
```
你是一个专业的绩效管理助手。请根据以下数据为员工生成本月工作总结：

员工信息：
- 姓名：{name}
- 岗位：{level}
- 部门：{department}

本月目标完成情况：
{goals_data}

参与项目：
{projects}

要求：
1. 总结字数200-300字
2. 包含：主要工作内容、目标完成情况、亮点成果
3. 语气：客观、专业、积极
4. 生成3个不同风格的版本供选择
```

### 经理评价提示词
```
你是部门经理，需要对员工进行月度绩效评价。

员工数据：
{employee_data}

员工自评：
{self_summary}

本月得分：
{scores}

目标完成情况：
{goal_progress}

历史表现：
{history}

团队对比：
- 团队平均分：{team_avg}
- 该员工排名：{rank}

请生成：
1. 综合评价（150-200字）
2. 推荐的评价关键词（3-5个正面 + 1-2个待改进）
3. 下月工作建议（100-150字）
```

---

## 安全与权限控制

### API调用限制
```typescript
// 每人每月限制
const AI_LIMITS = {
  employee: {
    maxCallsPerMonth: 10,  // 员工每月10次
    maxCallsPerDay: 3      // 每天3次
  },
  manager: {
    maxCallsPerMonth: 50,  // 经理每月50次
    maxCallsPerDay: 10     // 每天10次
  }
};
```

### 日志记录
```sql
CREATE TABLE ai_usage_logs (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  feature VARCHAR(50),  -- 'self_summary' | 'manager_comment'
  prompt_tokens INT,
  completion_tokens INT,
  cost DECIMAL(10,4),
  created_at TIMESTAMP
);
```

---

## 实现优先级

### Phase 1 - MVP（1-2天）
1. ✅ 后端API：员工自评AI生成
2. ✅ 前端UI：侧边栏AI助手
3. ✅ 数据抓取：目标、上月评价
4. ✅ Kimi API集成

### Phase 2 - 完善（1天）
1. ✅ 经理评价AI生成
2. ✅ 关键词智能推荐
3. ✅ 多版本生成对比

### Phase 3 - 优化（1天）
1. ✅ OpenClaw备用方案
2. ✅ 调用次数限制
3. ✅ 使用日志统计

---

## 成本估算

### Kimi API 定价
- 输入：¥0.001/1K tokens
- 输出：¥0.001/1K tokens

### 年度成本预估
```
场景1：员工自评
- 173员工 × 12月 × 2次/月 = 4,152次
- 平均 1,500 tokens/次
- 成本：约 ¥6.2/年

场景2：经理评价
- 173员工 × 12月 × 1次 = 2,076次
- 平均 3,000 tokens/次（数据更多）
- 成本：约 ¥6.2/年

总计：约 ¥12-15/年（极低）
```

OpenClaw 备用方案：**¥0（免费）**

---

## 推荐方案总结

### 🎯 最佳方案
**混合架构（方案D）+ 侧边栏UI（方案1）**

### 技术栈
- **主AI服务**: Kimi API（你已有key）
- **备用方案**: OpenClaw Agent
- **UI组件**: 侧边栏AI助手
- **数据抓取**: 后端API统一处理
- **安全控制**: 调用次数限制 + 日志记录

### 开发时间
- Phase 1 (MVP): 1-2天
- Phase 2 (完善): 1天
- Phase 3 (优化): 1天
- **总计: 3-4天**

### 运行成本
- Kimi API: ¥12-15/年
- OpenClaw: ¥0
- **总计: 可忽略不计**

---

## 下一步

确认方案后，我会：
1. 创建后端AI服务层
2. 设计前端AI助手组件
3. 实现数据抓取逻辑
4. 集成Kimi API + OpenClaw备份
5. 添加使用限制和日志

是否开始开发？
