# 绩效管理系统 - 自动化任务配置指南

## 📋 功能概述

系统已实现自动化绩效任务生成和冻结功能：

1. **每月1号自动生成月度绩效任务** - 为所有员工创建本月绩效记录
2. **每季度第一天生成总经理评分任务** - 为所有部门经理创建季度评分任务
3. **每天检查并冻结超期任务** - 自动冻结超过截止日期的任务

## 🔧 OpenClaw Cron 配置

### 1. 月度绩效任务生成

**时间**: 每月1号 00:00  
**任务**: 为所有员工生成本月绩效记录

```bash
# 在 OpenClaw 中创建 cron 任务（通过 Telegram 或 UI）
# Schedule: 每月1号 00:00
# Type: isolated session + agent turn
```

**Cron 表达式**: `0 0 1 * *`（每月1号凌晨0点）

**任务内容**:
```
请调用绩效管理系统的 /api/automation/generate-monthly-tasks 接口，为本月生成绩效任务。

执行步骤：
1. 使用 admin 账号登录获取 token
2. POST http://localhost:3001/api/automation/generate-monthly-tasks
3. 将结果发送到 Telegram

完成后告诉我生成了多少条任务。
```

### 2. 季度评分任务生成

**时间**: 每季度第一天 00:00（1月1日、4月1日、7月1日、10月1日）

**Cron 表达式**: `0 0 1 1,4,7,10 *`

**任务内容**:
```
请调用绩效管理系统的 /api/automation/generate-quarterly-tasks 接口，为本季度生成总经理评分任务。

执行步骤：
1. 使用 admin 账号登录获取 token
2. POST http://localhost:3001/api/automation/generate-quarterly-tasks
3. 将结果发送到 Telegram

完成后告诉我生成了多少个经理的评分任务。
```

### 3. 超期任务自动冻结

**时间**: 每天 00:00

**Cron 表达式**: `0 0 * * *`（每天凌晨0点）

**任务内容**:
```
请调用绩效管理系统的 /api/automation/freeze-overdue-tasks 接口，检查并冻结超期任务。

执行步骤：
1. 使用 admin 账号登录获取 token
2. POST http://localhost:3001/api/automation/freeze-overdue-tasks
3. 如果冻结了任务，发送通知到 Telegram

如果冻结数量 > 0，请告诉我冻结了多少条任务。
```

## 🎯 任务规则说明

### 月度绩效任务

- **生成时间**: 每月1号 00:00
- **目标用户**: 所有员工和经理（排除 GM/HR/Admin）
- **截止日期**: 下月3号
- **状态**: 初始为 `draft`

### 季度评分任务

- **生成时间**: 每季度第一天 00:00
- **目标用户**: 所有部门经理
- **评分对象**: 由总经理对部门经理进行季度评分

### 任务冻结规则

- **检查时间**: 每天 00:00
- **冻结条件**: 
  - 任务状态为 `draft` 或 `submitted`
  - 当前日期 > 截止日期
  - 未被冻结
- **冻结效果**:
  - 任务显示为灰色
  - 不可操作（查看、编辑、提交）
  - 只有 HR/Admin 可以解冻

## 🔓 HR 解冻功能

### 单个任务解冻

**接口**: `POST /api/automation/unfreeze/:recordId`  
**权限**: HR / Admin  
**说明**: 解冻指定的绩效记录

### 批量解冻

**接口**: `POST /api/automation/batch-unfreeze`  
**权限**: HR / Admin  
**参数**: `{ "month": "2026-02" }`  
**说明**: 解冻指定月份的所有冻结任务

## 📊 数据库字段

### performance_records 表新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `frozen` | BOOLEAN | 是否冻结（默认 false） |
| `deadline` | DATE | 截止日期（默认下月3号） |

## 🔄 手动触发（测试用）

可以通过以下方式手动测试任务生成：

```bash
# 1. 登录获取 token
TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.token')

# 2. 生成月度任务
curl -X POST http://localhost:3001/api/automation/generate-monthly-tasks \
  -H "Authorization: Bearer $TOKEN"

# 3. 冻结超期任务
curl -X POST http://localhost:3001/api/automation/freeze-overdue-tasks \
  -H "Authorization: Bearer $TOKEN"

# 4. 批量解冻（HR操作）
curl -X POST http://localhost:3001/api/automation/batch-unfreeze \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"month":"2026-02"}'
```

## ⚠️ 注意事项

1. **时区问题**: Cron 任务时间需要根据服务器时区调整
2. **重复生成**: 系统会自动跳过已存在的记录，不会重复生成
3. **权限要求**: Cron 任务需要使用 admin 账号的 token
4. **通知配置**: 建议配置 Telegram 通知，任务执行后自动汇报
5. **错误处理**: 如果任务执行失败，需要在日志中查看原因

## 📝 后续优化建议

1. 添加任务执行历史记录表
2. 添加邮件/企业微信通知功能
3. 支持自定义截止日期
4. 支持按部门配置不同的截止规则
5. 添加任务执行状态监控面板
