# å®¡è®¡æ—¥å¿—ä½¿ç”¨æŒ‡å—

**åŠŸèƒ½**: è®°å½•ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·æ“ä½œï¼Œæ”¯æŒæŸ¥è¯¢ã€è¿‡æ»¤ã€ç»Ÿè®¡åˆ†æ  
**æƒé™**: HR å’Œ admin å¯æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼Œæ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ—¥å¿—  
**ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2026-02-13

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®¡è®¡æ—¥å¿—è‡ªåŠ¨è®°å½•ç³»ç»Ÿä¸­çš„æ‰€æœ‰é‡è¦æ“ä½œï¼ŒåŒ…æ‹¬ï¼š

- âœ… ç”¨æˆ·ç™»å½•/ç™»å‡º
- âœ… åˆ›å»ºè®°å½•ï¼ˆå·¥ä½œæ€»ç»“ã€æ™‹å‡ç”³è¯·ã€ç”³è¯‰ç­‰ï¼‰
- âœ… ä¿®æ”¹è®°å½•ï¼ˆè¯„åˆ†ã€å®¡æ‰¹ã€ç›®æ ‡è°ƒæ•´ç­‰ï¼‰
- âœ… åˆ é™¤è®°å½•
- âœ… å®¡æ‰¹æ“ä½œ

æ¯æ¡æ—¥å¿—åŒ…å«ï¼š
- æ“ä½œäººä¿¡æ¯ï¼ˆIDã€å§“åã€è§’è‰²ï¼‰
- æ“ä½œè¯¦æƒ…ï¼ˆåŠ¨ä½œã€æ¨¡å—ã€ç›®æ ‡ï¼‰
- è¯·æ±‚ä¿¡æ¯ï¼ˆIPã€æµè§ˆå™¨ã€URLï¼‰
- æ“ä½œç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- æ—¶é—´æˆ³

---

## ğŸ” å¦‚ä½•æŸ¥è¯¢æ—¥å¿—

### 1. æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—ï¼ˆHR/adminï¼‰

**æ¥å£**: `GET /api/audit-logs`

**æ”¯æŒçš„ç­›é€‰å‚æ•°**:
- `user_id`: ç”¨æˆ·ID
- `action`: æ“ä½œç±»å‹ï¼ˆCREATE/UPDATE/DELETE/LOGIN/LOGOUTï¼‰
- `module`: æ¨¡å—ï¼ˆauth/performance/promotion/appeal/objectiveç­‰ï¼‰
- `target_type`: ç›®æ ‡ç±»å‹ï¼ˆperformance_record/promotion_requestç­‰ï¼‰
- `result`: ç»“æœï¼ˆSUCCESS/FAILED/UNAUTHORIZEDï¼‰
- `start_date`: å¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
- `end_date`: ç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤50ï¼‰

**ç¤ºä¾‹**:

```bash
# æŸ¥è¯¢æ‰€æœ‰ç™»å½•è®°å½•
curl -X GET "http://localhost:3001/api/audit-logs?action=LOGIN" \
  -H "Authorization: Bearer {token}"

# æŸ¥è¯¢æŸç”¨æˆ·çš„æ‰€æœ‰æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs?user_id=e001" \
  -H "Authorization: Bearer {token}"

# æŸ¥è¯¢æŸæ—¶é—´æ®µçš„å¤±è´¥æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs?result=FAILED&start_date=2026-02-01&end_date=2026-02-13" \
  -H "Authorization: Bearer {token}"

# ç»„åˆç­›é€‰ï¼šæŸ¥è¯¢æŸç”¨æˆ·åœ¨ç»©æ•ˆæ¨¡å—çš„æ‰€æœ‰æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs?user_id=e001&module=performance&page=1&limit=20" \
  -H "Authorization: Bearer {token}"
```

**å“åº”æ ¼å¼**:

```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "id": 1,
        "user_id": "admin",
        "user_name": null,
        "user_role": "admin",
        "action": "LOGIN",
        "module": "auth",
        "target_type": null,
        "target_id": null,
        "description": "æœªçŸ¥ç”¨æˆ· ç™»å½•ç³»ç»Ÿ",
        "changes": null,
        "ip_address": "::ffff:172.18.0.1",
        "user_agent": "curl/8.7.1",
        "request_method": "POST",
        "request_url": "/api/auth/login",
        "result": "SUCCESS",
        "error_message": null,
        "created_at": "2026-02-13T08:04:42.547Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 2,
      "totalPages": 1
    }
  }
}
```

### 2. æŸ¥è¯¢ç”¨æˆ·æ“ä½œå†å²

**æ¥å£**: `GET /api/audit-logs/user/:userId`

**å‚æ•°**:
- `limit`: æŸ¥è¯¢æ•°é‡ï¼ˆé»˜è®¤100ï¼‰

**æƒé™**: æœ¬äººæˆ–HR/admin

**ç¤ºä¾‹**:

```bash
# æŸ¥è¯¢è‡ªå·±çš„æ“ä½œå†å²
curl -X GET "http://localhost:3001/api/audit-logs/user/e001?limit=50" \
  -H "Authorization: Bearer {token}"
```

**ç”¨é€”**:
- å‘˜å·¥æŸ¥çœ‹è‡ªå·±çš„æ“ä½œè®°å½•
- HR å®¡è®¡æŸå‘˜å·¥çš„æ‰€æœ‰æ“ä½œ
- è¿½è¸ªé—®é¢˜æ—¶æŸ¥çœ‹æ“ä½œæ—¶é—´çº¿

### 3. æŸ¥è¯¢å¯¹è±¡æ“ä½œå†å²

**æ¥å£**: `GET /api/audit-logs/target/:type/:id`

**æƒé™**: ä»…HR/admin

**ç¤ºä¾‹**:

```bash
# æŸ¥è¯¢æŸæ¡å·¥ä½œæ€»ç»“çš„æ‰€æœ‰æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs/target/performance_record/rec-e001-2026-02" \
  -H "Authorization: Bearer {token}"

# æŸ¥è¯¢æŸä¸ªæ™‹å‡ç”³è¯·çš„æ“ä½œå†å²
curl -X GET "http://localhost:3001/api/audit-logs/target/promotion_request/pr-12345" \
  -H "Authorization: Bearer {token}"
```

**ç”¨é€”**:
- æŸ¥çœ‹æŸæ¡è®°å½•è¢«è°ä¿®æ”¹è¿‡
- è¿½è¸ªæ•°æ®å˜æ›´å†å²
- å®¡è®¡æ•æ„Ÿæ“ä½œ

### 4. æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯

**æ¥å£**: `GET /api/audit-logs/stats`

**æƒé™**: ä»…HR/admin

**ç¤ºä¾‹**:

```bash
curl -X GET "http://localhost:3001/api/audit-logs/stats" \
  -H "Authorization: Bearer {token}"
```

**å“åº”æ ¼å¼**:

```json
{
  "success": true,
  "data": {
    "totalLogs": 1000,
    "byAction": {
      "CREATE": 500,
      "UPDATE": 300,
      "DELETE": 50,
      "LOGIN": 100,
      "LOGOUT": 50
    },
    "byModule": {
      "performance": 600,
      "promotion": 200,
      "auth": 150,
      "appeal": 50
    },
    "byResult": {
      "SUCCESS": 900,
      "FAILED": 80,
      "UNAUTHORIZED": 20
    },
    "recentLogs": [...]
  }
}
```

**ç”¨é€”**:
- ç³»ç»Ÿä½¿ç”¨æƒ…å†µæ€»è§ˆ
- å‘ç°å¼‚å¸¸æ“ä½œï¼ˆé«˜å¤±è´¥ç‡ã€å¼‚å¸¸åˆ é™¤ç­‰ï¼‰
- ç”Ÿæˆå®¡è®¡æŠ¥å‘Š

---

## ğŸ’¡ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: è¿½è¸ªæ•°æ®å˜æ›´

**é—®é¢˜**: æŸæ¡å·¥ä½œæ€»ç»“çš„åˆ†æ•°è¢«ä¿®æ”¹äº†ï¼Œéœ€è¦çŸ¥é“è°æ”¹çš„ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:

```bash
# 1. æŸ¥è¯¢è¯¥è®°å½•çš„æ“ä½œå†å²
curl -X GET "http://localhost:3001/api/audit-logs/target/performance_record/rec-e001-2026-02" \
  -H "Authorization: Bearer {token}"

# 2. æŸ¥çœ‹è¿”å›çš„æ—¥å¿—ï¼Œæ‰¾åˆ° action=UPDATE çš„è®°å½•
# 3. æŸ¥çœ‹ user_name å’Œ created_atï¼Œç¡®è®¤ä¿®æ”¹äººå’Œæ—¶é—´
```

### åœºæ™¯2: å®¡è®¡å‘˜å·¥æ“ä½œ

**é—®é¢˜**: éœ€è¦å®¡è®¡æŸå‘˜å·¥åœ¨ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ“ä½œ

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æŸ¥è¯¢è¯¥å‘˜å·¥çš„æ‰€æœ‰æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs/user/e001" \
  -H "Authorization: Bearer {token}"
```

### åœºæ™¯3: æ’æŸ¥ç³»ç»Ÿé—®é¢˜

**é—®é¢˜**: ç³»ç»Ÿä¸­å‡ºç°äº†æ‰¹é‡åˆ é™¤æ“ä½œï¼Œéœ€è¦æ’æŸ¥

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æŸ¥è¯¢æ‰€æœ‰åˆ é™¤æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs?action=DELETE" \
  -H "Authorization: Bearer {token}"
```

### åœºæ™¯4: ç›‘æ§ç™»å½•å®‰å…¨

**é—®é¢˜**: æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸ç™»å½•

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æŸ¥è¯¢æ‰€æœ‰ç™»å½•å¤±è´¥è®°å½•
curl -X GET "http://localhost:3001/api/audit-logs?action=LOGIN&result=FAILED" \
  -H "Authorization: Bearer {token}"

# æŸ¥è¯¢æŸç”¨æˆ·çš„ç™»å½•å†å²
curl -X GET "http://localhost:3001/api/audit-logs?user_id=admin&action=LOGIN" \
  -H "Authorization: Bearer {token}"
```

### åœºæ™¯5: ç”Ÿæˆå®¡è®¡æŠ¥å‘Š

**é—®é¢˜**: éœ€è¦ç”Ÿæˆæœ¬æœˆçš„ç³»ç»Ÿä½¿ç”¨æŠ¥å‘Š

**è§£å†³æ–¹æ¡ˆ**:

```bash
# 1. æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
curl -X GET "http://localhost:3001/api/audit-logs/stats" \
  -H "Authorization: Bearer {token}"

# 2. æŸ¥è¯¢æœ¬æœˆçš„æ‰€æœ‰æ“ä½œ
curl -X GET "http://localhost:3001/api/audit-logs?start_date=2026-02-01&end_date=2026-02-28" \
  -H "Authorization: Bearer {token}"
```

---

## ğŸ—„ï¸ ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

å¦‚æœæœ‰æ•°æ®åº“è®¿é—®æƒé™ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŸ¥è¯¢ï¼š

```sql
-- 1. æŸ¥çœ‹æœ€è¿‘çš„100æ¡æ—¥å¿—
SELECT 
  user_id, user_name, action, module, description, 
  result, created_at
FROM audit_logs 
ORDER BY created_at DESC 
LIMIT 100;

-- 2. æŸ¥è¯¢æŸç”¨æˆ·çš„æ“ä½œ
SELECT * 
FROM audit_logs 
WHERE user_id = 'e001' 
ORDER BY created_at DESC;

-- 3. æŸ¥è¯¢å¤±è´¥çš„æ“ä½œ
SELECT 
  user_id, user_name, action, module, 
  error_message, created_at
FROM audit_logs 
WHERE result = 'FAILED' 
ORDER BY created_at DESC;

-- 4. ç»Ÿè®¡æ¯ä¸ªæ¨¡å—çš„æ“ä½œæ•°
SELECT 
  module, 
  COUNT(*) as total,
  SUM(CASE WHEN result = 'SUCCESS' THEN 1 ELSE 0 END) as success,
  SUM(CASE WHEN result = 'FAILED' THEN 1 ELSE 0 END) as failed
FROM audit_logs 
GROUP BY module 
ORDER BY total DESC;

-- 5. æŸ¥è¯¢æŸå¯¹è±¡çš„æ“ä½œå†å²
SELECT 
  user_id, user_name, action, description, 
  changes, created_at
FROM audit_logs 
WHERE target_type = 'performance_record' 
  AND target_id = 'rec-e001-2026-02'
ORDER BY created_at DESC;

-- 6. æŸ¥è¯¢ä»Šå¤©çš„æ‰€æœ‰æ“ä½œ
SELECT * 
FROM audit_logs 
WHERE created_at >= CURRENT_DATE 
ORDER BY created_at DESC;

-- 7. æŸ¥è¯¢æŸIPçš„æ‰€æœ‰æ“ä½œ
SELECT * 
FROM audit_logs 
WHERE ip_address = '192.168.1.100' 
ORDER BY created_at DESC;
```

---

## ğŸ” æƒé™è¯´æ˜

| è§’è‰² | æŸ¥çœ‹æ‰€æœ‰æ—¥å¿— | æŸ¥çœ‹è‡ªå·±æ—¥å¿— | æŸ¥çœ‹å¯¹è±¡å†å² | æŸ¥çœ‹ç»Ÿè®¡ |
|------|-------------|-------------|-------------|---------|
| admin | âœ… | âœ… | âœ… | âœ… |
| hr | âœ… | âœ… | âœ… | âœ… |
| gm | âŒ | âœ… | âŒ | âŒ |
| manager | âŒ | âœ… | âŒ | âŒ |
| employee | âŒ | âœ… | âŒ | âŒ |

---

## ğŸ“ æ—¥å¿—å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | integer | æ—¥å¿—IDï¼ˆè‡ªå¢ï¼‰|
| user_id | string | æ“ä½œäººID |
| user_name | string | æ“ä½œäººå§“å |
| user_role | string | æ“ä½œäººè§’è‰² |
| action | enum | æ“ä½œç±»å‹ï¼ˆCREATE/UPDATE/DELETE/LOGIN/LOGOUTï¼‰|
| module | string | æ¨¡å—ï¼ˆauth/performance/promotion/appealç­‰ï¼‰|
| target_type | string | ç›®æ ‡ç±»å‹ï¼ˆperformance_record/promotion_requestç­‰ï¼‰|
| target_id | string | ç›®æ ‡ID |
| description | text | æ“ä½œæè¿°ï¼ˆä¸­æ–‡ï¼‰|
| changes | jsonb | ä¿®æ”¹å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰|
| ip_address | string | æ“ä½œIPåœ°å€ |
| user_agent | text | æµè§ˆå™¨ä¿¡æ¯ |
| request_method | string | HTTPæ–¹æ³•ï¼ˆPOST/PUT/DELETEï¼‰|
| request_url | text | è¯·æ±‚URL |
| result | enum | æ“ä½œç»“æœï¼ˆSUCCESS/FAILED/UNAUTHORIZEDï¼‰|
| error_message | text | å¤±è´¥åŸå›  |
| created_at | timestamp | æ“ä½œæ—¶é—´ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**
   - æ—¥å¿—æŸ¥è¯¢æ”¯æŒåˆ†é¡µï¼Œå»ºè®®ä¸è¦ä¸€æ¬¡æŸ¥è¯¢å¤ªå¤šæ•°æ®
   - é»˜è®¤æ¯é¡µ50æ¡ï¼Œæœ€å¤šå»ºè®®ä¸è¶…è¿‡200æ¡
   - ä½¿ç”¨ç­›é€‰æ¡ä»¶å¯ä»¥æå‡æŸ¥è¯¢æ•ˆç‡

2. **æ•°æ®ä¿ç•™**
   - æ—¥å¿—ä¼šæ°¸ä¹…ä¿å­˜ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
   - æœªæ¥å¯èƒ½ä¼šå®ç°è‡ªåŠ¨å½’æ¡£ï¼ˆè¶…è¿‡6ä¸ªæœˆï¼‰

3. **éšç§ä¿æŠ¤**
   - å®¡è®¡æ—¥å¿—åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä»…é™HRå’ŒadminæŸ¥çœ‹
   - ä¸è¦å°†æ—¥å¿—å†…å®¹æ³„éœ²ç»™æ— å…³äººå‘˜

4. **å¼‚å¸¸æƒ…å†µ**
   - å¦‚æœå®¡è®¡æ—¥å¿—å†™å…¥å¤±è´¥ï¼Œä¸ä¼šå½±å“ä¸šåŠ¡æ“ä½œ
   - ç³»ç»Ÿä¼šåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯ï¼Œä½†ä¸ä¼šæŠ›å‡ºå¼‚å¸¸

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æµ‹è¯•å®¡è®¡æ—¥å¿—åŠŸèƒ½

```bash
# 1. ç™»å½•è·å–token
TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.data.token')

# 2. æ‰§è¡Œä¸€äº›æ“ä½œï¼ˆä¼šè¢«è®°å½•ï¼‰
curl -X POST http://localhost:3001/api/performance/summary \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"month":"2027-02","summary":"æµ‹è¯•","achievements":"æµ‹è¯•","issues":"æ— "}'

# 3. æŸ¥è¯¢å®¡è®¡æ—¥å¿—
curl http://localhost:3001/api/audit-logs -H "Authorization: Bearer $TOKEN" | jq .

# 4. æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:3001/api/audit-logs/stats -H "Authorization: Bearer $TOKEN" | jq .
```

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚

**æ–‡æ¡£æ›´æ–°**: 2026-02-13  
**ç‰ˆæœ¬**: v1.0
